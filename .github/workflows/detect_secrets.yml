name: Agentic Workflow

on:
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  contents: read
  pull-requests: write
  packages: read

jobs:
  run:
    runs-on: [self-hosted, mhp-workshop-runner]
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      MODEL_ID: $MODEL_ID
      GITHUB_PAT_TOKEN: ${{ secrets.GH_TOKEN }}
      GITHUB_REPO: ${{ github.repository }}
      GITHUB_OWNER: ${{ github.repository_owner }}
      TARGET_PR_NUMBER: ${{ github.event.pull_request.number }}
    steps:
      - name: Prepare toolcache (macOS/Linux)
        if: runner.os != 'Windows'
        run: |
          TOOL="$HOME/.cache/runner/_tool"
          TMP="$HOME/.cache/runner/_temp"
          mkdir -p "$TOOL" "$TMP"
          echo "RUNNER_TOOL_CACHE=$TOOL" >> $GITHUB_ENV
          echo "RUNNER_TEMP=$TMP"       >> $GITHUB_ENV
          echo "AGENT_TOOLSDIRECTORY=$TOOL" >> $GITHUB_ENV

      - name: Prepare toolcache (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $tool = "$env:USERPROFILE\.cache\runner\_tool"
          $tmp  = "$env:USERPROFILE\.cache\runner\_temp"
          New-Item -ItemType Directory -Force -Path $tool,$tmp | Out-Null
          "RUNNER_TOOL_CACHE=$tool" | Out-File -FilePath $env:GITHUB_ENV -Append
          "RUNNER_TEMP=$tmp"        | Out-File -FilePath $env:GITHUB_ENV -Append
          "AGENT_TOOLSDIRECTORY=$tool"   | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Debug toolcache vars
        run: env | egrep 'RUNNER_TOOL_CACHE|RUNNER_TEMP|AGENT_TOOLSDIRECTORY'    
        
      - name: Set up Python
        uses: actions/setup-python@v5
        env:
          AGENT_TOOLSDIRECTORY: ${{ env.AGENT_TOOLSDIRECTORY }}
          RUNNER_TOOL_CACHE: ${{ env.RUNNER_TOOL_CACHE }}
          RUNNER_TEMP: ${{ env.RUNNER_TEMP }}
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: 2.0.0
          virtualenvs-create: false

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Install dependencies
        working-directory: .
        run: |
          poetry install

      - name: Run agentic workflow
        working-directory: .
        run: |
          pwd
          echo "Running agentic workflow script..."
          poetry run start
